@{
    ViewBag.Title = "Productos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<ol class="breadcrumb mb-4 mt-4">
    <li class="breadcrumb-item"><a href="/">Mantenimiento</a></li>
    <li class="breadcrumb-item active">Productos</li>
</ol>

<div class="card">
    <div class="card-header">
        <i class="fas fa-box me-1"></i>Lista de Productos
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-12">
                <button type="button" class="btn btn-success" id="crearProductoBtn">Crear Producto</button>
            </div>
        </div>
        <hr />

        <table id="tProducto" class="display cell-border" style="width: 100%">
            <thead>
                <tr>
                    <th>IdProducto</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Marca</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                </tr>
            </tbody>
        </table>

    </div>
</div>

<!-- Modal Bootstrap -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <!-- Tamaño grande para acomodar más campos -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productoModalLabel">Detalles del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productoForm">
                    <input type="hidden" id="IdProducto" name="IdProducto">
                    <div class="mb-3">
                        <label for="NombreProducto" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="NombreProducto" name="NombreProducto" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="Descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="Descripcion" name="Descripcion" rows="3" required maxlength="500"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="IdMarca" class="form-label">Marca</label>
                        <select class="form-control" id="IdMarca" name="IdMarca" required>
                            <option value="">Seleccione una Marca</option>
                            <!-- Opciones cargadas dinámicamente -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="IdCategoria" class="form-label">Categoría</label>
                        <select class="form-control" id="IdCategoria" name="IdCategoria" required>
                            <option value="">Seleccione una Categoría</option>
                            <!-- Opciones cargadas dinámicamente -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="Precio" class="form-label">Precio</label>
                        <input type="number" step="0.01" class="form-control" id="Precio" name="Precio" required min="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="Stock" class="form-label">Stock</label>
                        <input type="number" step="1" class="form-control" id="Stock" name="Stock" required min="0">
                    </div>
                    <div class="mb-3">
                        <label for="RutaImagen" class="form-label">Ruta de la Imagen</label>
                        <input type="text" class="form-control" id="RutaImagen" name="RutaImagen" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label for="NombreImagen" class="form-label">Nombre de la Imagen</label>
                        <input type="text" class="form-control" id="NombreImagen" name="NombreImagen" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="Estado" class="form-label">Estado</label>
                        <select class="form-control" id="Estado" name="Estado" required>
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                    <!-- Puedes agregar más campos si es necesario -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="saveProductoBtn">Guardar cambios</button>
            </div>
        </div>
    </div>
</div>

@section scripts{

    <script>
        $(document).ready(function () {
            // Inicializar DataTable
            $('#tProducto').DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: "/Productos/Listar",
                    type: "GET",
                    datatype: "json",
                    dataSrc: "data"
                },
                columns: [
                    { data: "IdProducto" },
                    { data: "NombreProducto" },
                    { data: "Descripcion" },
                    { data: "oMarca.NombreMarca" }, 
                    { data: "oCategoria.DescripcionCategoria" }, 
                    {
                        data: "Precio",
                        render: function (data) {
                            return '$' + parseFloat(data).toFixed(2);
                        }
                    },
                    { data: "Stock" },
                    {
                        data: "Estado",
                        render: function (data) {
                            return data ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-danger">Inactivo</span>';
                        }
                    },
                    {
                        data: "FechaRegistro",
                        render: function (data) {
                            var date = new Date(data);
                            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        }
                    },
                    {
                        data: "IdProducto",
                        render: function (data) {
                            return `
                                <button class="btn btn-primary btn-sm" onclick="editarProducto(${data})"><i class="fas fa-pen"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${data})"><i class="fas fa-trash"></i></button>`;
                        }
                    }
                ],
                language: {
                    emptyTable: "No hay productos disponibles",
                    lengthMenu: "Mostrar _MENU_ productos por página",
                    zeroRecords: "No se encontraron resultados",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ productos",
                    infoEmpty: "Mostrando 0 a 0 de 0 productos",
                    infoFiltered: "(filtrado de _MAX_ total de productos)",
                    search: "Buscar:",
                    paginate: {
                        first: "Primero",
                        last: "Último",
                        next: "Siguiente",
                        previous: "Anterior"
                    }
                }
            });

            // Botón Guardar/Cambiar en el modal
            $('#saveProductoBtn').click(function () {
                var id = $('#IdProducto').val();
                if (id) {
                    actualizarProducto(id);
                } else {
                    guardarProducto();
                }
            });

            $('#crearProductoBtn').click(function () {
                // Limpiar el formulario
                $('#productoForm')[0].reset();
                $('#IdProducto').val('');
                $('#saveProductoBtn').show();
                $('#productoModalLabel').text('Crear Producto');

                // Habilitar todos los campos
                $('#productoForm input, #productoForm select, #productoForm textarea').prop('disabled', false);

                // Cargar Marcas y Categorías en los select
                cargarMarcas();
                cargarCategorias();

                $('#productoModal').modal('show');
            });
        });

        // Función para cargar las Marcas en el select
        function cargarMarcas(selectedId) {
            $.ajax({
                url: '/Marcas/Listar',
                type: 'GET',
                success: function (response) {
                    if (response.data) {
                        $('#IdMarca').empty().append('<option value="">Seleccione una Marca</option>');
                        $.each(response.data, function (index, marca) {
                            var selected = marca.IdMarca === selectedId ? 'selected' : '';
                            $('#IdMarca').append(`<option value="${marca.IdMarca}" ${selected}>${marca.NombreMarca}</option>`);
                        });
                    } else {
                        alert('No se pudieron cargar las marcas.');
                    }
                },
                error: function () {
                    alert('Error al cargar las marcas.');
                }
            });
        }

        // Función para cargar las Categorías en el select
        function cargarCategorias(selectedId) {
            $.ajax({
                url: '/Mantenimientos/ListarCategorias', 
                type: 'GET',
                success: function (response) {
                    if (response.data) {
                        $('#IdCategoria').empty().append('<option value="">Seleccione una Categoría</option>');
                        $.each(response.data, function (index, categoria) {
                            var selected = categoria.IdCategoria === selectedId ? 'selected' : '';
                            $('#IdCategoria').append(`<option value="${categoria.IdCategoria}" ${selected}>${categoria.DescripcionCategoria}</option>`);
                        });
                    } else {
                        alert('No se pudieron cargar las categorías.');
                    }
                },
                error: function () {
                    alert('Error al cargar las categorías.');
                }
            });
        }

        // Función para abrir el modal con los detalles del producto (solo lectura)
        function verProducto(id) {
            $.ajax({
                url: '/Productos/Detalle/' + id,
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        var producto = response.data;
                        $('#IdProducto').val(producto.IdProducto);
                        $('#NombreProducto').val(producto.NombreProducto).prop('disabled', true);
                        $('#Descripcion').val(producto.Descripcion).prop('disabled', true);
                        $('#IdMarca').empty().append(`<option value="${producto.oMarca.IdMarca}">${producto.oMarca.NombreMarca}</option>`).prop('disabled', true);
                        $('#IdCategoria').empty().append(`<option value="${producto.oCategoria.IdCategoria}">${producto.oCategoria.DescripcionCategoria}</option>`).prop('disabled', true);
                        $('#Precio').val(producto.Precio).prop('disabled', true);
                        $('#Stock').val(producto.Stock).prop('disabled', true);
                        $('#RutaImagen').val(producto.RutaImagen).prop('disabled', true);
                        $('#NombreImagen').val(producto.NombreImagen).prop('disabled', true);
                        $('#Estado').val(producto.Estado.toString()).prop('disabled', true);
                        $('#productoModalLabel').text('Detalles del Producto');
                        $('#saveProductoBtn').hide();
                        $('#productoModal').modal('show');
                    } else {
                        alert(response.message);
                    }
                }
            });
        }

        // Función para abrir el modal para editar el producto
        function editarProducto(id) {
            $.ajax({
                url: '/Productos/Detalle/' + id,
                type: 'GET',
                success: function (response) {
                    if (response.success) {
                        var producto = response.data;
                        $('#IdProducto').val(producto.IdProducto);
                        $('#NombreProducto').val(producto.NombreProducto).prop('disabled', false);
                        $('#Descripcion').val(producto.Descripcion).prop('disabled', false);
                        cargarMarcas(producto.oMarca.IdMarca);
                        cargarCategorias(producto.oCategoria.IdCategoria);
                        $('#Precio').val(producto.Precio).prop('disabled', false);
                        $('#Stock').val(producto.Stock).prop('disabled', false);
                        $('#RutaImagen').val(producto.RutaImagen).prop('disabled', false);
                        $('#NombreImagen').val(producto.NombreImagen).prop('disabled', false);
                        $('#Estado').val(producto.Estado.toString()).prop('disabled', false);
                        $('#productoModalLabel').text('Editar Producto');
                        $('#saveProductoBtn').show();
                        $('#productoModal').modal('show');
                    } else {
                        alert(response.message);
                    }
                }
            });
        }

        // Función para guardar un nuevo producto
        function guardarProducto() {
            var data = {
                NombreProducto: $('#NombreProducto').val(),
                Descripcion: $('#Descripcion').val(),
                oMarca: {
                    IdMarca: parseInt($('#IdMarca').val())
                },
                oCategoria: {
                    IdCategoria: parseInt($('#IdCategoria').val())
                },
                Precio: parseFloat($('#Precio').val()),
                Stock: parseFloat($('#Stock').val()),
                RutaImagen: $('#RutaImagen').val(),
                NombreImagen: $('#NombreImagen').val(),
                Estado: $('#Estado').val() === 'true'
            };
            $.ajax({
                url: '/Productos/Crear',
                type: 'POST',
                data: data,
                success: function (response) {
                    if (response.success) {
                        $('#tProducto').DataTable().ajax.reload();
                        $('#productoModal').modal('hide');
                        alert('Producto creado exitosamente.');
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function () {
                    alert('Error al crear el producto.');
                }
            });
        }

        // Función para actualizar un producto existente
        function actualizarProducto(id) {
            var data = {
                IdProducto: parseInt($('#IdProducto').val()),
                NombreProducto: $('#NombreProducto').val(),
                Descripcion: $('#Descripcion').val(),
                oMarca: {
                    IdMarca: parseInt($('#IdMarca').val())
                },
                oCategoria: {
                    IdCategoria: parseInt($('#IdCategoria').val())
                },
                Precio: parseFloat($('#Precio').val()),
                Stock: parseFloat($('#Stock').val()),
                RutaImagen: $('#RutaImagen').val(),
                NombreImagen: $('#NombreImagen').val(),
                Estado: $('#Estado').val() === 'true'
            };
            $.ajax({
                url: '/Productos/Actualizar',
                type: 'POST',
                data: data,
                success: function (response) {
                    if (response.success) {
                        $('#tProducto').DataTable().ajax.reload();
                        $('#productoModal').modal('hide');
                        alert('Producto actualizado exitosamente.');
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function () {
                    alert('Error al actualizar el producto.');
                }
            });
        }

        // Función para eliminar un producto
        function eliminarProducto(id) {
            if (confirm("¿Estás seguro de que deseas eliminar este producto?")) {
                $.ajax({
                    url: '/Productos/Eliminar',
                    type: 'POST',
                    data: { id: id },
                    success: function (response) {
                        if (response.success) {
                            $('#tProducto').DataTable().ajax.reload();
                            alert('Producto eliminado exitosamente.');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Error al eliminar el producto.');
                    }
                });
            }
        }

    </script>

}
